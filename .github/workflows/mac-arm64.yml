name: Nextflow Conda MacOS ARM64 Pipeline

on:
  workflow_dispatch:
  push:
    paths:
    - 'pipelines/macos-arm64/nextflow-conda/**'
    - '.github/workflows/mac-arm64.yml'

jobs:
  prepare-environment:
    runs-on: macos-14
    defaults:
      run:
        shell: bash -l {0}
    steps:
    - uses: actions/checkout@v4

    - name: Cache Conda environment and Nextflow
      id: cache-env
      uses: actions/cache@v4
      with:
        path: |
          ~/miniconda
          /usr/local/bin/nextflow
        key: ${{ runner.os }}-miniconda-nextflow-arm64-stable

    - name: Set up Miniconda
      if: steps.cache-env.outputs.cache-hit != 'true'
      uses: conda-incubator/setup-miniconda@v2
      with:
        miniconda-version: "latest"
        architecture: arm64
        auto-update-conda: true
        auto-activate-base: false

    - name: Install Nextflow
      if: steps.cache-env.outputs.cache-hit != 'true'
      run: |
        curl -s https://get.nextflow.io | bash
        sudo mv nextflow /usr/local/bin/

    - name: Verify installations
      run: |
        conda --version
        nextflow -v

    - name: Install tracer
      continue-on-error: true
      run: |
        curl -sSL https://install.tracer.cloud/ | bash
        source ~/.bashrc
        # Add tracer to GitHub Actions PATH for subsequent steps
        echo "$HOME/.local/bin" >> $GITHUB_PATH
        echo "/usr/local/bin" >> $GITHUB_PATH

    - name: Run tracer init
      run: |
        # Ensure tracer is in PATH
        export PATH="$HOME/.local/bin:/usr/local/bin:$PATH"
        tracer init --pipeline-name github-actions --environment github-actions --user-operator github-actions --pipeline-type nextflow --is-dev true

    - name: Run pipeline
      working-directory: pipelines/macos-arm64/nextflow-conda
      run: |
        bash run.sh

    - name: Run tracer INFO to verify that the right packages have been installed
      run: |
        # Ensure tracer is in PATH
        export PATH="$HOME/.local/bin:/usr/local/bin:$PATH"
        tracer info
