name: Nextflow Conda MacOS ARM64 Pipeline

on:
  workflow_dispatch:
  push:
    paths:
    - 'pipelines/macos-arm64/nextflow-conda/**'
    - '.github/workflows/mac-arm64.yml'

jobs:
  run-pipeline:
    runs-on: macos-14
    steps:
    - uses: actions/checkout@v4

    - name: Cache Conda environment and Nextflow
      id: cache-env
      uses: actions/cache@v4
      with:
        path: |
          ~/miniconda
          /usr/local/bin/nextflow
        key: ${{ runner.os }}-miniconda-nextflow-arm64-stable

    - name: Set up Miniconda and Nextflow
      if: steps.cache-env.outputs.cache-hit != 'true'
      run: |
        curl -sL https://repo.anaconda.com/miniconda/Miniconda3-latest-MacOSX-arm64.sh -o miniconda.sh
        bash miniconda.sh -b -p $HOME/miniconda
        export PATH="$HOME/miniconda/bin:$PATH"
        conda update -y -n base -c defaults conda

        curl -s https://get.nextflow.io | bash
        sudo mv nextflow /usr/local/bin/

    - name: Install tracer and initialize pipeline
      run: |
        export PATH="$HOME/miniconda/bin:$PATH"

        echo "Verifying Conda and Nextflow:"
        conda --version
        nextflow -v

        echo "Installing tracer:"
        curl -sSL https://install.tracer.cloud/ | bash && source ~/.bashrc

        echo "Initializing tracer:"
        tracer init \
          --pipeline-name github-actions \
          --environment github-actions \
          --user-operator github-actions \
          --pipeline-type nextflow \
          --is-dev true

    - name: Run pipeline
      working-directory: pipelines/macos-arm64/nextflow-conda
      run: |
        export PATH="$HOME/miniconda/bin:$PATH"
        bash run.sh
